name: Generate Sentinel Demo Data

on:
  # Run on a schedule (default: every 6 hours)
  schedule:
    - cron: '0 */6 * * *'
  
  # Allow manual trigger from GitHub UI
  workflow_dispatch:
    inputs:
      count:
        description: 'Number of events per scenario'
        required: false
        default: '50'
      log_level:
        description: 'Logging level'
        required: false
        default: 'INFO'
        type: choice
        options:
          - DEBUG
          - INFO
          - WARNING
          - ERROR
      build_docker:
        description: 'Build and push Docker image'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.12'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  generate:
    name: Generate and Send Data
    runs-on: ubuntu-latest
    
    # Required for OIDC authentication (if using federated credentials)
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Set up config
        run: cp config/config.example.yaml config/config.yaml

      - name: Generate and send data to Sentinel
        env:
          # Azure authentication (Service Principal)
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          # Data Collection settings
          SENTINEL_DCE_ENDPOINT: ${{ secrets.SENTINEL_DCE_ENDPOINT }}
          SENTINEL_DCR_ID: ${{ secrets.SENTINEL_DCR_ID }}
        run: |
          python -m sentinel_data_generator \
            --output log_analytics \
            --count ${{ github.event.inputs.count || '50' }} \
            --log-level ${{ github.event.inputs.log_level || 'INFO' }}

      - name: Summary
        if: always()
        run: |
          echo "## Sentinel Data Generator Run" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Count per scenario | ${{ github.event.inputs.count || '50' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Log level | ${{ github.event.inputs.log_level || 'INFO' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Scenarios Executed (11 total)" >> $GITHUB_STEP_SUMMARY
          echo "| Table | Scenarios |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| **SecurityEventDemo_CL** | brute_force_login, privilege_escalation |" >> $GITHUB_STEP_SUMMARY
          echo "| **CommonSecurityLog** (native) | firewall_traffic, ids_intrusion_detection, threat_intel_matches |" >> $GITHUB_STEP_SUMMARY
          echo "| **SigninLogDemo_CL** | suspicious_signins, brute_force_aad, credential_stuffing |" >> $GITHUB_STEP_SUMMARY
          echo "| **SyslogDemo_CL** | ssh_brute_force, linux_auth_events, service_anomalies |" >> $GITHUB_STEP_SUMMARY

  docker-build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: generate
    if: ${{ github.event.inputs.build_docker == 'true' }}
    
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

      - name: Image Summary
        run: |
          echo "## Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Image pushed to: \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Tags:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
